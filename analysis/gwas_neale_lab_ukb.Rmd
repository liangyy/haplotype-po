---
title: "What GWAS to use for PRS among Neale's lab UK Biobank GWASs?"
date: "`r paste0('Last update: ', format(Sys.time(), '%b %d, %Y'))`"    
---


```{r setup}
rm(list = ls())
library(pander)
panderOptions('table.split.table', Inf)
library(ggplot2)
library(dplyr)
library(data.table)
options(datatable.fread.datatable = FALSE)
theme_set(theme_bw(base_size=15))
set.seed(2020)

# load some gists
source('https://gist.githubusercontent.com/liangyy/43912b3ecab5d10c89f9d4b2669871c9/raw/3ca651cfa53ffccb8422f432561138a46e93710f/my_ggplot_theme.R')

# load dependent scripts
source('../code/rlib_misc.R')
```

# About

To build PRS, we need to have external GWAS results.
Here we focus on the GWASs generated by Neale's lab using UK Biobank data.
The main goal here is to determine which GWAS phenotype could be used for which parental illness phenotype.
Also, we have sex specific GWASs, so that they should be considered as well.

# Load data

Load parental illness phenotypes.

```{r pitrait}
list_init = readRDS('../analysis_output/parent_illness_init_phenotypes_clean_up.rds')
df_parental_illness = list_init$code
rm(list_init)
df_parental_illness = rbind(
  df_parental_illness$father,
  df_parental_illness$mother
) %>% distinct() %>% filter(code > 0)
df_parental_illness %>% 
  pander(caption = 'Parental illness (combined from mother and father)')
```

Load Neale's lab GWAS sheet.

```{r, gwas_sheet}
# downloaded from 
# https://docs.google.com/spreadsheets/d/1kvPoupSzsSFBNSztMzl04xMoSC3Kcx3CrjVf4yBmESU 
# Sheet="Manifest 201807"
# download date: 4/17/20
df_gwas = read.csv('~/Downloads/UKBB GWAS Imputed v3 - File Manifest Release 20180731 - Manifest 201807.csv')
```


Load self reported Data Field 20002 (non-cancer illness).

```{r, selfreport_noncancer}
# downloaded from here: http://biobank.ctsu.ox.ac.uk/crystal/coding.cgi?id=6
df_self_report_noncancer = read.delim2('~/Downloads/coding6.tsv')
field_self_report_noncancer = 20002
```

Load self reported Data Field 20001 (cancer illness).

```{r, selfreport_cancer}
# downloaded from here: http://biobank.ctsu.ox.ac.uk/crystal/coding.cgi?id=3
df_self_report_cancer = read.delim2('~/Downloads/coding3.tsv')
field_self_report_cancer = 20001
```

Load ICD-10 Data Field 41202 

```{r, icd10}
# downloaded from here: http://biobank.ctsu.ox.ac.uk/crystal/coding.cgi?id=19
df_icd10 = read.delim2('~/Downloads/coding19.tsv')
field_icd10 = 41202
```

# Going through parental illness one by one

The procedure and principle:

* Search in Neale's lab GWAS sheet on related keyword.
* Select the UK Biobank phenotype if it has "Data Field" page. For others, it is hard to keep track of what is going on.
* Self reported and ICD-10 are included (ICD-9 is not in this set of GWASs).

```{r, gwas_init}
get_code = function(pool, code, target) {
  code[pool %in% target]
}
gwas_container = list()
indices = 1 : nrow(df_parental_illness) 
i = 1
```

## Heart disease

* Keyword: 'heart', 'Heart'
* Result: 
    - Non-cancer illness code, self-reported: heart/cardiac problem.
    - ICD-10: there are some related but **not sure** which one to use.
    - Other: None

```
I24,Diagnoses - main ICD10: I24 Other acute ischaemic heart diseases,http://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=41202
I25,Diagnoses - main ICD10: I25 Chronic ischaemic heart disease,http://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=41202
I27,Diagnoses - main ICD10: I27 Other pulmonary heart diseases,http://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=41202
I51,Diagnoses - main ICD10: I51 Complications and ill-defined descriptions of heart disease,http://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=41202
```

```{r heart}
disease = df_parental_illness$choice[indices[i]]
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_noncancer$meaning, df_self_report_noncancer$coding, 'heart/cardiac problem')
neale_id = paste0(field_self_report_noncancer, '_', code)
# icd-10
# other
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## Stroke

* Keyword: 'stroke', 'Stroke'
* Result: 
    - Non-cancer illness code, self-reported: stroke
    - ICD-10: "I64 Stroke, not specified as haemorrhage or infarction" **not sure** if it is relevant.
    - Other: Vascular/heart problems diagnosed by doctor (6150_3)

```{r stroke}
disease = df_parental_illness$choice[indices[i]]
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_noncancer$meaning, df_self_report_noncancer$coding, 'stroke')
neale_id = paste0(field_self_report_noncancer, '_', code)
# icd-10
# other
neale_id = c(
  neale_id,
  '6150_3'
)
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## High blood pressure 

* Keyword: 'hypertension', 'Hypertension', 'blood pressure'
* Result: 
    - Non-cancer illness code, self-reported: hypertension, essential hypertension.
    - ICD-10: "I10 Essential (primary) hypertension" sounds relevant.
    - Other: 6150_4,Vascular/heart problems diagnosed by doctor: High blood pressure.

```{r high}
disease = df_parental_illness$choice[indices[i]] 
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_noncancer$meaning, df_self_report_noncancer$coding, c('hypertension', 'essential hypertension'))
neale_id = paste0(field_self_report_noncancer, '_', code)
# icd-10
neale_id = c(neale_id, 'I10')
# other
neale_id = c(neale_id, '6150_4')
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## Diabetes

**Note**: I focus on T2D.

* Keyword: 'diabete', 'Diabete'
* Result: 
    - Non-cancer illness code, self-reported: diabetes and type 2 diabetes.
    - ICD-10: Two records in the line. **Not sure** what to use.
```
E10,Diagnoses - main ICD10: E10 Insulin-dependent diabetes mellitus,http://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=41202
E11,Diagnoses - main ICD10: E11 Non-insulin-dependent diabetes mellitus,http://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=41202
E14,Diagnoses - main ICD10: E14 Unspecified diabetes mellitus,http://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=41202
```
    - Other: 2443,Diabetes diagnosed by doctor.
    

```{r diabetes}
disease = df_parental_illness$choice[indices[i]] 
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_noncancer$meaning, df_self_report_noncancer$coding, c('diabetes', 'type 2 diabetes'))
neale_id = paste0(field_self_report_noncancer, '_', code)
# icd-10
# other
neale_id = c(neale_id, '2443')
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## Chronic bronchitis/emphysema

* Keyword: 'bronchitis', 'Bronchitis', 'emphysema', 'Emphysema'
* Result: 
    - Non-cancer illness code, self-reported: emphysema/chronic bronchitis, bronchitis, emphysema.
    - ICD-10: "J43,Diagnoses - main ICD10: J43 Emphysema". I excluded two more on bronchitis since they are **not clear** to me.
```
J20,Diagnoses - main ICD10: J20 Acute bronchitis,http://biobank.ctsu.ox.ac.uk/crystal/field.cgi?id=41202
J40,"Diagnoses - main ICD10: J40 Bronchitis, not specified as acute or chronic"
```
    - Other: 22128,Doctor diagnosed emphysema and 22129,Doctor diagnosed chronic bronchitis.
    

```{r chronic}
disease = df_parental_illness$choice[indices[i]] 
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_noncancer$meaning, df_self_report_noncancer$coding, c('emphysema/chronic bronchitis', 'bronchitis', 'emphysema'))
neale_id = paste0(field_self_report_noncancer, '_', code)
# icd-10
neale_id = c(neale_id, 'J43')
# other
neale_id = c(neale_id, '22128', '22129')
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## Alzheimer's disease/dementia (skip)

```{r alzheimer}
i = i + 1
```

## Parkinson's disease

* Keyword: 'Parkinson', 'parkinson'
* Result: 
    - Non-cancer illness code, self-reported: parkinsons disease.
    - ICD-10: "G20,Diagnoses - main ICD10: G20 Parkinson's disease".
    - Other: None
    

```{r parkinsons}
disease = df_parental_illness$choice[indices[i]] 
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_noncancer$meaning, df_self_report_noncancer$coding, c('parkinsons disease'))
neale_id = paste0(field_self_report_noncancer, '_', code)
# icd-10
neale_id = c(neale_id, 'G20')
# other
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## Severe depression

* Keyword: 'depression', 'Depression'
* Result: 
    - Non-cancer illness code, self-reported: depression.
    - Other: 
        + 20126_3,Bipolar and major depression status: Probable Recurrent major depression (severe)
        + 20126_4,Bipolar and major depression status: Probable Recurrent major depression (moderate)
        + 20544_11,Mental health problems ever diagnosed by a professional: Depression
    

```{r severe}
disease = df_parental_illness$choice[indices[i]] 
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_noncancer$meaning, df_self_report_noncancer$coding, c('depression'))
neale_id = paste0(field_self_report_noncancer, '_', code)
# icd-10
# other
neale_id = c(neale_id, '20126_3', '20126_4', '20544_11')
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## Lung cancer

* Keyword: 'Lung', 'lung' followed by 'cancer', 'Cancer'
* Result: 
    - Cancer code, self-reported: lung cancer.
    - Other: 22140,Doctor diagnosed lung cancer (not mesothelioma)
    

```{r lung_cancer}
disease = df_parental_illness$choice[indices[i]] 
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_cancer$meaning, df_self_report_cancer$coding, c('lung cancer'))
neale_id = paste0(field_self_report_cancer, '_', code)
# icd-10
# other
neale_id = c(neale_id, '22140')
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## Bowel cancer

* Keyword: 'Bowel', 'bowel' followed by 'cancer', 'Cancer'
* Result: 
    - Cancer code, self-reported: small intestine/small bowel cancer, large bowel cancer/colorectal cancer. (These are closest)
    - Other: None

```{r bowel_cancer}
disease = df_parental_illness$choice[indices[i]] 
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_cancer$meaning, df_self_report_cancer$coding, c('small intestine/small bowel cancer', 'large bowel cancer/colorectal cancer'))
neale_id = paste0(field_self_report_cancer, '_', code)
# icd-10
# other
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## Prostate cancer

* Keyword: 'Prostate', 'prostate' followed by 'cancer', 'Cancer'
* Result: 
    - Cancer code, self-reported: prostate cancer
    - Other: None

```{r prostate_cancer}
disease = df_parental_illness$choice[indices[i]] 
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_cancer$meaning, df_self_report_cancer$coding, c('prostate cancer'))
neale_id = paste0(field_self_report_cancer, '_', code)
# icd-10
# other
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

## Breast cancer

* Keyword: 'Breast', 'breast' followed by 'cancer', 'Cancer'
* Result: 
    - Cancer code, self-reported: breast cancer
    - Other: None

```{r breast_cancer}
disease = df_parental_illness$choice[indices[i]] 
i = i + 1
message('Processing ', disease)
# self-reported
code = get_code(df_self_report_cancer$meaning, df_self_report_cancer$coding, c('breast cancer'))
neale_id = paste0(field_self_report_cancer, '_', code)
# icd-10
# other
gwas_container[[length(gwas_container) + 1]] = data.frame(disease = disease, gwas_code = neale_id)
```

# Summarize and generate download script

```{r summarize}
df_gwas_container = do.call(rbind, gwas_container)
df_gwas_container = df_gwas_container %>% left_join(
  df_gwas %>% select(Phenotype.Code, Sex, wget.command), 
  by = c('gwas_code' = 'Phenotype.Code'))
write.csv(df_gwas_container, '../analysis_output/summary.gwas_neale_lab.csv')
```

```{r show}
df_gwas_container %>% group_by(disease, Sex) %>% summarize(ngwas = n()) %>% pander
```

# Grouping GWASs

For efficient computation, I need to group the GWASs into batches.

```{r group_gwas}
get_partition = function(ngrp, ntotal) {
  size = floor(ntotal / ngrp)
  o = c()
  for(i in 1 : ngrp) {
    o = c(o, rep(i, size))
  }
  o = c(o, rep(ngrp, ntotal - (ngrp * size)))
  return(o)
}
gwas_df = read.csv('../analysis_output/summary.gwas_neale_lab.csv')
gwas_df$id = fread(cmd = "cat ../analysis_output/summary.gwas_neale_lab.csv |tail -n +2 | cut -d, -f 5|awk -F\"/\" '{print $6}'| awk -F\"?\" '{print $1}' | sed 's#.tsv.bgz##g'", header = FALSE, data.table = FALSE)$V1
ngroup = 10
gwas_df$groupid = paste0('_group', get_partition(ngroup, nrow(gwas_df)), '_')
# save to text
gwas_df %>% select(id, groupid) %>% write.table('../analysis_output/analysis_batch.gwas_neale_lab.txt', quote = F, row.names = F, col.names = F, sep = '\t')
```
